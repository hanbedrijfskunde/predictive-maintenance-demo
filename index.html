<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PredictivePulse AI - Realistic Digital Twin Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f1f5f9;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }

        .status-pulse {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .pulse-green { background: #22c55e; box-shadow: 0 0 10px #22c55e; animation: pulse 2s infinite; }
        .pulse-yellow { background: #eab308; box-shadow: 0 0 10px #eab308; animation: pulse 2s infinite; }
        .pulse-red { background: #ef4444; box-shadow: 0 0 10px #ef4444; animation: pulse 2s infinite; }

        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 1; }
            70% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(0.95); opacity: 1; }
        }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .modal-overlay {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(8px);
        }

        .twin-svg { transition: all 0.5s ease; }
        .component-label { font-size: 8px; fill: #64748b; font-weight: bold; text-transform: uppercase; }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Header -->
    <header class="max-w-7xl mx-auto mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-400">
                PredictivePulse AI <span class="text-xs uppercase bg-indigo-500 text-white px-2 py-0.5 rounded ml-2 align-middle">Digital Twin v3</span>
            </h1>
            <p class="text-slate-400">Geavanceerde Asset Monitoring & Simulatie</p>
        </div>
        <div class="flex gap-4">
            <div class="glass-card px-4 py-2 flex items-center gap-3">
                <span class="text-sm text-slate-400">Vloot Status</span>
                <span id="fleet-status-badge" class="px-2 py-1 bg-green-500/20 text-green-400 rounded text-xs font-bold border border-green-500/30 tracking-widest uppercase">Optimaal</span>
            </div>
            <button onclick="resetSimulation()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg font-semibold transition-all">
                Reset Data
            </button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <!-- Sidebar: Machine Lijst -->
        <aside class="lg:col-span-3 space-y-6">
            <h2 class="text-xl font-semibold px-2">Installed Base</h2>
            <div id="machine-list" class="space-y-3"></div>

            <!-- Historische Vergelijking -->
            <div class="glass-card p-4 border-t-2 border-indigo-500/50">
                <h3 class="text-xs font-bold text-slate-400 mb-4 uppercase tracking-tighter">Impact op Business</h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-[10px] text-slate-300">Downtime reductie</span>
                        <span class="text-emerald-400 font-bold text-xs">↑ 38%</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-[10px] text-slate-300">Besparing op inkt/materiaal</span>
                        <span class="text-emerald-400 font-bold text-xs">↑ 12.4%</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-[10px] text-slate-300">OEE Verbetering</span>
                        <span class="text-blue-400 font-bold text-xs">↑ 9.2%</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <section class="lg:col-span-9 space-y-6">
            
            <!-- Machine Header + Realistische Digital Twin -->
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                <!-- Info Card -->
                <div class="glass-card p-6 md:col-span-7 flex flex-col justify-between">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 id="active-name" class="text-2xl font-bold italic">--</h2>
                            <p id="active-id" class="text-slate-500 text-sm tracking-widest uppercase mt-1">S/N: --</p>
                            <p id="active-type" class="text-indigo-400 text-xs font-bold uppercase mt-1">--</p>
                        </div>
                        <div class="text-right">
                             <p class="text-slate-400 text-xs uppercase mb-1">Health Score</p>
                             <p id="active-health" class="text-4xl font-bold">--%</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mt-8">
                        <div class="bg-slate-800/50 p-4 rounded-xl border border-white/5 shadow-inner">
                            <p class="text-slate-400 text-[10px] uppercase font-bold tracking-widest">Resterende Levensduur</p>
                            <p id="active-rul" class="text-2xl font-bold text-blue-400">-- Dgn</p>
                        </div>
                        <div class="bg-slate-800/50 p-4 rounded-xl border border-white/5 shadow-inner">
                            <p class="text-slate-400 text-[10px] uppercase font-bold tracking-widest">Slijtage Profiel</p>
                            <p id="active-trend" class="text-2xl font-bold">--</p>
                        </div>
                    </div>
                </div>

                <!-- Digital Twin Card -->
                <div class="glass-card p-4 md:col-span-5 flex flex-col items-center justify-center relative overflow-hidden min-h-[300px]">
                    <h3 class="absolute top-4 left-4 text-[10px] font-bold text-slate-500 uppercase flex items-center gap-2">
                        <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span> Live Digital Twin
                    </h3>
                    
                    <div id="digital-twin-container" class="w-full h-full flex items-center justify-center py-8">
                        <!-- SVGs worden hier dynamisch geladen -->
                    </div>

                    <div id="twin-status-badge" class="absolute bottom-4 right-4 text-[10px] bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 px-2 py-1 rounded">
                        COMPONENTS: OK
                    </div>
                </div>
            </div>

            <!-- Sensors & Analysis -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass-card p-4 h-64">
                    <h3 class="text-sm font-bold text-slate-400 mb-4 uppercase">Sensor Telemetrie (Real-time)</h3>
                    <canvas id="telemetryChart"></canvas>
                </div>
                <div class="glass-card p-4 h-64">
                    <h3 class="text-sm font-bold text-slate-400 mb-4 uppercase">AI Inzichten & Anomalieën</h3>
                    <div id="alert-log" class="text-[11px] space-y-2 overflow-y-auto h-44 custom-scroll pr-2"></div>
                </div>
            </div>

            <!-- Recommendation Panel -->
            <div id="recommendation-panel" class="glass-card p-6 border-l-4 border-emerald-500 shadow-lg">
                <div class="flex justify-between items-center gap-6">
                    <div>
                        <h3 class="text-lg font-bold">Aanbevolen Acties</h3>
                        <p id="action-desc" class="text-sm text-slate-400 mt-1">Geen actie vereist. Parameters zijn stabiel.</p>
                    </div>
                    <div id="action-button-container"></div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal: Service Planning -->
    <div id="service-modal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden p-4">
        <div class="glass-card w-full max-w-5xl max-h-[90vh] overflow-y-auto custom-scroll shadow-2xl border-indigo-500/30">
            <div class="p-6 border-b border-white/10 flex justify-between items-center sticky top-0 bg-[#1e293b] z-10">
                <div>
                    <h2 class="text-2xl font-bold">Service Intelligence Planner</h2>
                    <p id="modal-machine-title" class="text-indigo-400 font-mono text-sm uppercase"></p>
                </div>
                <button onclick="closeServiceModal()" class="text-slate-400 hover:text-white text-3xl">&times;</button>
            </div>
            
            <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Column 1: Diagnose -->
                <div class="space-y-6">
                    <div>
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 tracking-widest">AI Root Cause Analysis</h4>
                        <div id="modal-diagnose-list" class="space-y-3"></div>
                    </div>
                    <div class="bg-indigo-500/10 p-4 rounded-xl border border-indigo-500/20">
                        <h4 class="text-xs font-bold text-indigo-400 uppercase mb-1">Service Type</h4>
                        <p id="modal-service-type" class="text-lg font-semibold text-white italic"></p>
                    </div>
                </div>

                <!-- Column 2: Monteurs -->
                <div>
                    <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 tracking-widest">Beschikbare Experts</h4>
                    <div id="modal-engineers" class="space-y-3"></div>
                </div>

                <!-- Column 3: Onderdelen -->
                <div class="space-y-6">
                    <div>
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 tracking-widest">Onderdelen (Magazijn)</h4>
                        <div id="modal-parts-stock" class="space-y-2"></div>
                    </div>
                    <div>
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 tracking-widest">Inkoop Order (Extern)</h4>
                        <div id="modal-parts-order" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <div class="p-6 border-t border-white/10 bg-slate-900/50 flex justify-end gap-4">
                <button onclick="closeServiceModal()" class="px-6 py-2 text-slate-400 hover:text-white transition-colors">Sluiten</button>
                <button onclick="confirmService()" class="px-8 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold transition-all shadow-lg shadow-indigo-500/20">Bevestig Planning & Bestelling</button>
            </div>
        </div>
    </div>

    <script>
        // --- MACHINE TYPE SVG SCHEMATICS ---
        const twinGraphics = {
            'Offset Printing': `
                <svg viewBox="0 0 160 100" class="twin-svg w-full max-w-[280px]">
                    <rect x="5" y="60" width="30" height="20" rx="2" fill="#334155" />
                    <text x="10" y="90" class="component-label">Invoer</text>
                    <rect x="40" y="20" width="20" height="60" rx="1" fill="#475569" />
                    <rect x="65" y="20" width="20" height="60" rx="1" fill="#475569" />
                    <rect x="90" y="20" width="20" height="60" rx="1" fill="#475569" />
                    <circle cx="50" cy="40" r="4" fill="#64748b" id="offset-roller-1" />
                    <circle cx="75" cy="40" r="4" fill="#64748b" id="offset-roller-2" />
                    <circle cx="100" cy="40" r="4" fill="#64748b" id="offset-roller-3" />
                    <circle id="twin-hotspot" cx="75" cy="40" r="8" fill="red" opacity="0">
                        <animate attributeName="r" values="6;10;6" dur="2s" repeatCount="indefinite" />
                    </circle>
                    <rect x="115" y="60" width="40" height="20" rx="2" fill="#334155" />
                    <text x="120" y="90" class="component-label">Uitvoer</text>
                </svg>`,
            'Digital Inkjet': `
                <svg viewBox="0 0 160 100" class="twin-svg w-full max-w-[280px]">
                    <rect x="10" y="70" width="140" height="10" rx="2" fill="#334155" />
                    <line x1="15" y1="65" x2="145" y2="65" stroke="#475569" stroke-width="3" stroke-dasharray="5,2" />
                    <rect x="40" y="10" width="80" height="15" rx="2" fill="#475569" />
                    <rect x="45" y="25" width="15" height="15" rx="1" fill="#64748b" id="ink-head-1" />
                    <rect x="65" y="25" width="15" height="15" rx="1" fill="#64748b" id="ink-head-2" />
                    <rect x="85" y="25" width="15" height="15" rx="1" fill="#64748b" id="ink-head-3" />
                    <rect x="105" y="25" width="15" height="15" rx="1" fill="#64748b" id="ink-head-4" />
                    <circle id="twin-hotspot" cx="112" cy="32" r="8" fill="red" opacity="0">
                        <animate attributeName="r" values="6;10;6" dur="2s" repeatCount="indefinite" />
                    </circle>
                    <text x="65" y="55" class="component-label">Printbrug Matrix</text>
                </svg>`,
            'Packaging Production': `
                <svg viewBox="0 0 160 100" class="twin-svg w-full max-w-[280px]">
                    <rect x="5" y="80" width="150" height="15" rx="2" fill="#1e293b" />
                    <rect x="20" y="20" width="50" height="60" rx="1" fill="#475569" />
                    <path d="M25,50 L65,50 M45,25 L45,75" stroke="#334155" stroke-width="2" />
                    <rect x="80" y="40" width="60" height="40" rx="1" fill="#475569" />
                    <circle cx="20" cy="50" r="6" fill="#64748b" id="pack-gear-1" />
                    <circle cx="140" cy="60" r="5" fill="#64748b" id="pack-gear-2" />
                    <circle id="twin-hotspot" cx="45" cy="50" r="10" fill="red" opacity="0">
                        <animate attributeName="r" values="8;12;8" dur="2s" repeatCount="indefinite" />
                    </circle>
                    <text x="25" y="15" class="component-label">Stans Unit</text>
                    <text x="85" y="35" class="component-label">Vouw/Lijm Sectie</text>
                </svg>`
        };

        // --- DATA ---
        let machines = [
            { 
                id: 'OFF-XL-01', name: 'Offsetdruk XL-75', type: 'Offset Printing', serial: 'OS-2025-001', health: 100, rul: 210, temp: 36, vibe: 0.1, history: [], status: 'ok', prevStatus: 'ok', drift: 0.15,
                diagnose: [{ cause: 'Normale wals-slijtage', confidence: 99 }],
                parts: ['Walsen-set B1', 'Vochtfilter G2'],
                hotspotLabel: 'Wals Unit'
            },
            { 
                id: 'INK-JET-X2', name: 'Digital Inkjet Pro 8', type: 'Digital Inkjet', serial: 'DI-2024-992', health: 100, rul: 34, temp: 38, vibe: 0.15, history: [], status: 'ok', prevStatus: 'ok', drift: 0.35,
                diagnose: [{ cause: 'Nozzle verstopping Unit 4', confidence: 88 }, { cause: 'Inkt-toevoer drukval', confidence: 45 }],
                parts: ['Printkop PH-800', 'Inktfilter Micro'],
                hotspotLabel: 'Nozzle Matrix'
            },
            { 
                id: 'PACK-CUT-09', name: 'Vouw/Stans Combo 9', type: 'Packaging Production', serial: 'PC-2023-884', health: 100, rul: 120, temp: 42, vibe: 0.2, history: [], status: 'ok', prevStatus: 'ok', drift: 1.2,
                diagnose: [{ cause: 'Stansmes bot (Groep A)', confidence: 94 }, { cause: 'Aandrijfriem frictie', confidence: 72 }],
                parts: ['Stansmes-set 40mm', 'Aandrijfriem XL-Belt'],
                hotspotLabel: 'Stans Unit'
            }
        ];

        const engineers = [
            { name: 'Marco Willems', level: 'Senior Graphic Specialist', avail: 'Direct', certified: true },
            { name: 'Karin de Groot', level: 'Digital Inkjet Expert', avail: 'Morgen 09:00', certified: true },
            { name: 'Tom Bos', level: 'Mechanical Tech', avail: 'Vandaag 15:30', certified: false },
            { name: 'Ahmed Zarou', level: 'Field Service Lead', avail: 'Maandag', certified: true }
        ];

        const inventory = {
            'Walsen-set B1': { stock: 4, price: '€1.200,-', leadTime: 'Direct' },
            'Vochtfilter G2': { stock: 12, price: '€45,-', leadTime: 'Direct' },
            'Printkop PH-800': { stock: 1, price: '€4.850,-', leadTime: 'Direct' },
            'Inktfilter Micro': { stock: 0, price: '€120,-', supplier: 'InkJect Parts DE', leadTime: '1 werkdag' },
            'Stansmes-set 40mm': { stock: 0, price: '€890,-', supplier: 'EuroCutters NL', leadTime: '3 werkdagen' },
            'Aandrijfriem XL-Belt': { stock: 2, price: '€210,-', leadTime: 'Direct' }
        };

        let selectedId = machines[0].id;
        let chartInstance = null;

        // --- SIMULATIE ENGINE ---
        function updateSimulation() {
            machines.forEach(m => {
                const noise = (Math.random() - 0.5) * 2;
                
                // Incident kans verlaagd naar 2% per update (voorheen ~6%)
                let incidentJump = 0;
                if (Math.random() > 0.98) { 
                    incidentJump = Math.random() * 1.2 * m.drift;
                    addAlert(m.id, `AI-Analyse: Subtiele afwijking in ${Math.random() > 0.5 ? 'vibratiepatroon' : 'thermische balans'} gedetecteerd.`);
                    // Incident heeft nu minder directe impact op health
                    m.health -= (1 + Math.random() * 2); 
                }

                // Natuurlijke achteruitgang (drifts zijn ook verlaagd voor tragere degradatie)
                m.vibe += (Math.random() * 0.04 * m.drift) + (incidentJump * 0.15);
                m.temp += (Math.random() * 0.1 * m.drift) + (incidentJump * 0.6);
                
                let healthImpact = (m.vibe * 20) + (m.temp / 10);
                m.health = Math.max(0, Math.min(m.health, 100 - healthImpact));
                m.rul = Math.max(0, Math.round(m.health * 1.8));
                
                // Status bepaling
                const oldStatus = m.status;
                m.status = m.health > 85 ? 'ok' : m.health > 45 ? 'warning' : 'danger';
                
                // Status Transition Listener
                if (oldStatus !== m.status) {
                    if (m.status === 'warning') {
                        addAlert(m.id, `Waarschuwing: Conditie onder drempelwaarde. Serviceplanning geadviseerd.`);
                    } else if (m.status === 'danger') {
                        addAlert(m.id, `KRITIEK: Onmiddellijke actie vereist om stilstand te voorkomen.`);
                    } else if (m.status === 'ok') {
                        addAlert(m.id, `Status hersteld naar optimaal.`);
                    }
                }

                m.history.push({ 
                    time: new Date().toLocaleTimeString(), 
                    vibe: m.vibe + (noise * 0.05), 
                    temp: m.temp + noise 
                });
                if (m.history.length > 20) m.history.shift();
            });
            updateUI();
        }

        // --- UI FUNCTIES ---
        function updateUI() {
            renderMachineList();
            renderActiveMachine();
            updateChart();
            updateFleetStatus();
        }

        function renderMachineList() {
            const list = document.getElementById('machine-list');
            list.innerHTML = machines.map(m => `
                <div onclick="selectMachine('${m.id}')" class="glass-card p-4 cursor-pointer transition-all border-l-4 ${selectedId === m.id ? 'border-indigo-500 bg-indigo-500/10' : 'border-transparent hover:border-slate-500'}">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-sm">${m.name}</p>
                            <p class="text-[9px] text-slate-500 font-mono tracking-widest">${m.id}</p>
                        </div>
                        <span class="status-pulse ${m.status === 'ok' ? 'pulse-green' : m.status === 'warning' ? 'pulse-yellow' : 'pulse-red'}"></span>
                    </div>
                </div>
            `).join('');
        }

        function renderActiveMachine() {
            const m = machines.find(x => x.id === selectedId);
            if (!m) return;

            document.getElementById('active-name').innerText = m.name;
            document.getElementById('active-id').innerText = `S/N: ${m.serial} | ID: ${m.id}`;
            document.getElementById('active-type').innerText = m.type;
            document.getElementById('active-health').innerText = `${Math.round(m.health)}%`;
            document.getElementById('active-rul').innerText = `${m.rul} Dgn`;
            
            const healthEl = document.getElementById('active-health');
            healthEl.className = `text-4xl font-bold ${m.status === 'ok' ? 'text-emerald-400' : m.status === 'warning' ? 'text-yellow-400' : 'text-red-400'}`;

            document.getElementById('active-trend').innerText = m.status === 'ok' ? 'OPTIMAAL' : m.status === 'warning' ? 'AFWIJKEND' : 'KRITIEK';
            document.getElementById('active-trend').className = `text-2xl font-bold ${m.status === 'ok' ? 'text-emerald-400' : m.status === 'warning' ? 'text-yellow-400' : 'text-red-400'}`;

            const container = document.getElementById('digital-twin-container');
            container.innerHTML = twinGraphics[m.type];
            
            const hotspot = document.getElementById('twin-hotspot');
            const twinBadge = document.getElementById('twin-status-badge');
            
            if (m.status === 'ok') {
                hotspot.style.opacity = "0";
                twinBadge.innerText = "COMPONENTS: OK";
                twinBadge.className = "absolute bottom-4 right-4 text-[10px] bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 px-2 py-1 rounded";
            } else {
                hotspot.style.opacity = m.status === 'warning' ? "0.5" : "1";
                twinBadge.innerText = `ANOMALIE: ${m.hotspotLabel}`;
                twinBadge.className = `absolute bottom-4 right-4 text-[10px] border px-2 py-1 rounded ${m.status === 'warning' ? 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20' : 'bg-red-500/10 text-red-400 border-red-500/20'}`;
            }

            const recDesc = document.getElementById('action-desc');
            const btnContainer = document.getElementById('action-button-container');

            if (m.status === 'ok') {
                recDesc.innerText = "Systeem draait binnen de parameters. Geen actie nodig.";
                btnContainer.innerHTML = '';
            } else {
                recDesc.innerText = m.status === 'warning' ? "AI detecteert degradatie in de " + m.hotspotLabel + ". Preventieve planning geadviseerd." : "KRITIEK: Direct handelen vereist in de " + m.hotspotLabel + ". Stilstand dreigt.";
                btnContainer.innerHTML = `<button onclick="openServiceModal('${m.id}')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-3 rounded-xl font-bold transition-all shadow-lg shadow-indigo-500/20">Plan Service</button>`;
            }
        }

        // --- MODAL LOGICA ---
        function openServiceModal(id) {
            const m = machines.find(x => x.id === id);
            document.getElementById('modal-machine-title').innerText = `${m.name} [${m.id}]`;
            
            document.getElementById('modal-diagnose-list').innerHTML = m.diagnose.map(d => `
                <div class="flex justify-between items-center text-sm p-3 bg-white/5 rounded-lg border border-white/5">
                    <span>${d.cause}</span>
                    <span class="font-bold text-indigo-400 text-xs">${d.confidence}% Zekerheid</span>
                </div>
            `).join('');

            document.getElementById('modal-service-type').innerText = m.status === 'warning' ? 'Preventief (Conditie-afhankelijk)' : 'Urgent Correctief (Systeemherstel)';

            document.getElementById('modal-engineers').innerHTML = engineers.map(e => `
                <div class="flex items-center gap-3 p-3 glass-card border-white/5 hover:border-indigo-500/50 transition-all cursor-pointer">
                    <div class="w-10 h-10 rounded-lg bg-slate-700 flex items-center justify-center font-bold text-xs text-indigo-300">
                        ${e.name.split(' ').map(n => n[0]).join('')}
                    </div>
                    <div class="flex-1">
                        <p class="text-xs font-bold">${e.name}</p>
                        <p class="text-[9px] text-slate-400 tracking-tight">${e.level}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[9px] font-bold ${e.avail === 'Direct' ? 'text-emerald-400' : 'text-slate-400'}">${e.avail}</p>
                        ${e.certified ? '<span class="text-[7px] bg-indigo-500/20 text-indigo-300 px-1 rounded">GEAUTORISEERD</span>' : ''}
                    </div>
                </div>
            `).join('');

            let stockHtml = '';
            let orderHtml = '';
            m.parts.forEach(pName => {
                const item = inventory[pName];
                if (!item) return;
                if (item.stock > 0) {
                    stockHtml += `<div class="flex justify-between items-center text-[11px] p-2 bg-white/5 rounded-md mb-2"><span>${pName}</span><span class="text-emerald-400 font-bold">${item.stock} st.</span></div>`;
                } else {
                    orderHtml += `<div class="p-3 bg-red-500/5 border border-red-500/10 rounded-lg mb-2"><div class="flex justify-between text-[11px] font-bold"><span>${pName}</span><span class="text-red-400">${item.leadTime}</span></div><p class="text-[9px] text-slate-500 mt-1">Ref: ${item.supplier}</p></div>`;
                }
            });

            document.getElementById('modal-parts-stock').innerHTML = stockHtml || '<p class="text-[10px] text-slate-500 italic">Geen lokale voorraad.</p>';
            document.getElementById('modal-parts-order').innerHTML = orderHtml || '<p class="text-[10px] text-slate-500 italic">Geen externe bestelling nodig.</p>';
            document.getElementById('service-modal').classList.remove('hidden');
        }

        function closeServiceModal() {
            document.getElementById('service-modal').classList.add('hidden');
        }

        function confirmService() {
            addAlert(selectedId, `Service succesvol ingepland: Planning bevestigd.`);
            closeServiceModal();
            const m = machines.find(x => x.id === selectedId);
            m.vibe = 0.05 + Math.random() * 0.05;
            m.temp = 32 + Math.random() * 4;
            m.health = 100;
            m.status = 'ok';
        }

        function selectMachine(id) {
            selectedId = id;
            updateUI();
        }

        function addAlert(machineId, msg) {
            const log = document.getElementById('alert-log');
            const entry = document.createElement('p');
            entry.className = 'mb-1 py-1 border-b border-slate-800 last:border-0';
            entry.innerHTML = `<span class="text-slate-500">[${new Date().toLocaleTimeString()}]</span> <span class="text-indigo-400 font-bold">${machineId}:</span> ${msg}`;
            log.prepend(entry);
            if (log.children.length > 25) log.removeChild(log.lastChild);
        }

        function resetSimulation() {
            machines.forEach(m => {
                m.vibe = 0.08;
                m.temp = 34 + Math.random() * 2;
                m.history = [];
                m.health = 100;
                m.status = 'ok';
            });
            document.getElementById('alert-log').innerHTML = '';
            updateSimulation();
        }

        function updateFleetStatus() {
            const badge = document.getElementById('fleet-status-badge');
            const dangerCount = machines.filter(m => m.status === 'danger').length;
            const warningCount = machines.filter(m => m.status === 'warning').length;
            
            if (dangerCount > 0) {
                badge.innerText = "CRITICAL WARNING";
                badge.className = "px-2 py-1 bg-red-500/20 text-red-400 rounded text-xs font-bold border border-red-500/30 tracking-widest uppercase";
            } else if (warningCount > 0) {
                badge.innerText = "PLANNING NODIG";
                badge.className = "px-2 py-1 bg-yellow-500/20 text-yellow-400 rounded text-xs font-bold border border-yellow-500/30 tracking-widest uppercase";
            } else {
                badge.innerText = "OPTIMAAL";
                badge.className = "px-2 py-1 bg-green-500/20 text-green-400 rounded text-xs font-bold border border-green-500/30 tracking-widest uppercase";
            }
        }

        function updateChart() {
            const m = machines.find(x => x.id === selectedId);
            if (!m || !m.history.length) return;
            const labels = m.history.map(h => h.time);
            if (!chartInstance) {
                const ctx = document.getElementById('telemetryChart').getContext('2d');
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Vibratie', data: m.history.map(h => h.vibe), borderColor: '#6366f1', tension: 0.4, fill: false, pointRadius: 0 },
                            { label: 'Temp', data: m.history.map(h => h.temp), borderColor: '#fbbf24', tension: 0.4, fill: false, pointRadius: 0 }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        animation: false,
                        plugins: { legend: { display: false } }, 
                        scales: { 
                            x: { display: false }, 
                            y: { display: true, grid: { color: '#1e293b' }, ticks: { color: '#64748b', font: { size: 9 } } } 
                        } 
                    }
                });
            } else {
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].data = m.history.map(h => h.vibe);
                chartInstance.data.datasets[1].data = m.history.map(h => h.temp);
                chartInstance.update('none');
            }
        }

        setInterval(updateSimulation, 2500);
        updateSimulation();
    </script>
</body>
</html>